<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Import - Asset Monitor</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .csv-import-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .upload-section {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        transition: border-color 0.3s;
      }

      .upload-section.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }

      .upload-btn:hover {
        background: #0056b3;
      }

      .upload-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .options-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .option-group {
        margin: 15px 0;
      }

      .option-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .option-group input[type="checkbox"] {
        margin-right: 8px;
      }

      .progress-section {
        margin: 20px 0;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s;
      }

      .results-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .stat-card {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }

      .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
      }

      .error-list {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
      }

      .error-item {
        background: #f8d7da;
        color: #721c24;
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        font-size: 14px;
      }

      .validation-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
      }

      .validation-success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
      }

      .validation-error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
      }

      .sample-data {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
      }

      .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .sample-table th,
      .sample-table td {
        border: 1px solid #ddd;
        padding: 4px 6px;
        text-align: left;
      }

      .sample-table th {
        background: #f8f9fa;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üìä CSV Import Tool</h1>
        <nav>
          <a href="index.html">Dashboard</a>
          <a href="assets.html">Assets</a>
          <a href="csv-import.html" class="active">CSV Import</a>
        </nav>
      </header>

      <div class="csv-import-container">
        <h2>Import UPCB Asset Inventory</h2>
        <p>
          Upload your CSV file to import asset inventory data into the system.
        </p>

        <!-- File Upload Section -->
        <div class="upload-section" id="uploadSection">
          <h3>üìÅ Upload CSV File</h3>
          <p>Drag and drop your CSV file here or click to browse</p>
          <input type="file" id="csvFile" class="file-input" accept=".csv" />
          <button
            class="upload-btn"
            onclick="document.getElementById('csvFile').click()"
          >
            Choose File
          </button>
          <div id="fileInfo"></div>
        </div>

        <!-- Import Options -->
        <div class="options-section">
          <h3>‚öôÔ∏è Import Options</h3>

          <div class="option-group">
            <label>
              <input type="checkbox" id="dryRun" checked />
              Dry Run (Preview only, don't import)
            </label>
            <small
              >Check this to see what would be imported without actually
              importing</small
            >
          </div>

          <div class="option-group">
            <label>
              <input type="checkbox" id="updateExisting" />
              Update Existing Assets
            </label>
            <small>Update assets that already exist in the database</small>
          </div>

          <div class="option-group">
            <label>
              <input type="checkbox" id="skipDuplicates" checked />
              Skip Duplicates
            </label>
            <small>Skip assets that already exist (if not updating)</small>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin: 20px 0">
          <button class="upload-btn" onclick="validateCSV()" id="validateBtn">
            üîç Validate CSV
          </button>
          <button
            class="upload-btn"
            onclick="importCSV()"
            id="importBtn"
            disabled
          >
            üì• Import CSV
          </button>
          <button
            class="upload-btn"
            onclick="importCleanFile()"
            id="importCleanBtn"
          >
            üöÄ Import Clean File
          </button>
          <button
            class="upload-btn"
            onclick="checkDatabaseStatus()"
            id="statusBtn"
          >
            üìä Check Database
          </button>
          <button class="upload-btn" onclick="exportCSV()" id="exportBtn">
            üì§ Export Assets
          </button>
        </div>

        <!-- Validation Results -->
        <div class="validation-section" id="validationSection">
          <h3>üîç Validation Results</h3>
          <div id="validationContent"></div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
          <h3>‚è≥ Import Progress</h3>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p id="progressText">Preparing import...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
          <h3>üìä Import Results</h3>
          <div class="stats-grid" id="statsGrid"></div>
          <div id="errorList" class="error-list"></div>
        </div>
      </div>
    </div>

    <script>
      let selectedFile = null;

      // File upload handling
      document
        .getElementById("csvFile")
        .addEventListener("change", function (e) {
          selectedFile = e.target.files[0];
          if (selectedFile) {
            document.getElementById("fileInfo").innerHTML = `
                    <p><strong>Selected File:</strong> ${selectedFile.name}</p>
                    <p><strong>Size:</strong> ${(
                      selectedFile.size / 1024
                    ).toFixed(2)} KB</p>
                `;
            document.getElementById("validateBtn").disabled = false;
            document.getElementById("importBtn").disabled = false;
          }
        });

      // Drag and drop handling
      const uploadSection = document.getElementById("uploadSection");

      uploadSection.addEventListener("dragover", function (e) {
        e.preventDefault();
        uploadSection.classList.add("dragover");
      });

      uploadSection.addEventListener("dragleave", function (e) {
        e.preventDefault();
        uploadSection.classList.remove("dragover");
      });

      uploadSection.addEventListener("drop", function (e) {
        e.preventDefault();
        uploadSection.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          selectedFile = files[0];
          document.getElementById("csvFile").files = files;
          document.getElementById("fileInfo").innerHTML = `
                    <p><strong>Selected File:</strong> ${selectedFile.name}</p>
                    <p><strong>Size:</strong> ${(
                      selectedFile.size / 1024
                    ).toFixed(2)} KB</p>
                `;
          document.getElementById("validateBtn").disabled = false;
          document.getElementById("importBtn").disabled = false;
        }
      });

      // Validate CSV
      async function validateCSV() {
        if (!selectedFile) {
          alert("Please select a CSV file first");
          return;
        }

        const formData = new FormData();
        formData.append("csvFile", selectedFile);

        try {
          const response = await fetch("/api/csv-import/validate", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showValidationResults(result.validation);
          } else {
            alert("Validation failed: " + result.message);
          }
        } catch (error) {
          console.error("Validation error:", error);
          alert("Error validating CSV file");
        }
      }

      // Show validation results
      function showValidationResults(validation) {
        const section = document.getElementById("validationSection");
        const content = document.getElementById("validationContent");

        if (validation.isValid) {
          content.innerHTML = `
                    <div class="validation-success">
                        ‚úÖ CSV file is valid! Found ${
                          validation.totalRows
                        } rows.
                    </div>
                    <h4>Found Columns:</h4>
                    <p>${validation.foundColumns.join(", ")}</p>
                    <h4>Sample Data:</h4>
                    <div class="sample-data">
                        <table class="sample-table">
                            <thead>
                                <tr>
                                    ${Object.keys(
                                      validation.sampleData[0] || {}
                                    )
                                      .map((col) => `<th>${col}</th>`)
                                      .join("")}
                                </tr>
                            </thead>
                            <tbody>
                                ${validation.sampleData
                                  .map(
                                    (row) => `
                                    <tr>
                                        ${Object.values(row)
                                          .map((val) => `<td>${val || ""}</td>`)
                                          .join("")}
                                    </tr>
                                `
                                  )
                                  .join("")}
                            </tbody>
                        </table>
                    </div>
                `;
        } else {
          content.innerHTML = `
                    <div class="validation-error">
                        ‚ùå CSV file is invalid! Missing required columns: ${validation.missingColumns.join(
                          ", "
                        )}
                    </div>
                    <h4>Found Columns:</h4>
                    <p>${validation.foundColumns.join(", ")}</p>
                `;
        }

        section.style.display = "block";
      }

      // Import CSV
      async function importCSV() {
        if (!selectedFile) {
          alert("Please select a CSV file first");
          return;
        }

        const formData = new FormData();
        formData.append("csvFile", selectedFile);
        formData.append("dryRun", document.getElementById("dryRun").checked);
        formData.append(
          "updateExisting",
          document.getElementById("updateExisting").checked
        );
        formData.append(
          "skipDuplicates",
          document.getElementById("skipDuplicates").checked
        );

        // Show progress
        document.getElementById("progressSection").style.display = "block";
        document.getElementById("progressFill").style.width = "50%";
        document.getElementById("progressText").textContent =
          "Importing CSV file...";

        try {
          const response = await fetch("/api/csv-import/import", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          document.getElementById("progressFill").style.width = "100%";
          document.getElementById("progressText").textContent =
            "Import completed!";

          if (result.success) {
            showImportResults(result.stats);
          } else {
            alert("Import failed: " + result.message);
          }
        } catch (error) {
          console.error("Import error:", error);
          alert("Error importing CSV file");
        }
      }

      // Show import results
      function showImportResults(stats) {
        const section = document.getElementById("resultsSection");
        const statsGrid = document.getElementById("statsGrid");
        const errorList = document.getElementById("errorList");

        statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Rows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.imported}</div>
                    <div class="stat-label">Imported</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.skipped}</div>
                    <div class="stat-label">Skipped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.errors}</div>
                    <div class="stat-label">Errors</div>
                </div>
            `;

        if (stats.errors_list && stats.errors_list.length > 0) {
          errorList.innerHTML =
            "<h4>Errors:</h4>" +
            stats.errors_list
              .map(
                (error) => `
                        <div class="error-item">
                            Row ${error.row}: ${error.error}
                        </div>
                    `
              )
              .join("");
        } else {
          errorList.innerHTML = "";
        }

        section.style.display = "block";
      }

      // Import Clean File
      async function importCleanFile() {
        try {
          // Show progress
          document.getElementById("progressSection").style.display = "block";
          document.getElementById("progressFill").style.width = "25%";
          document.getElementById("progressText").textContent =
            "Importing clean file...";

          const response = await fetch("/api/csv-import/import-clean-file", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              dryRun: false,
              updateExisting: false,
              skipDuplicates: true,
            }),
          });

          const result = await response.json();

          document.getElementById("progressFill").style.width = "100%";
          document.getElementById("progressText").textContent =
            "Import completed!";

          if (result.success) {
            showImportResults(result.stats);
            alert("‚úÖ Clean file imported successfully!");
          } else {
            alert("‚ùå Import failed: " + result.message);
          }
        } catch (error) {
          console.error("Clean file import error:", error);
          alert("Error importing clean file");
        }
      }

      // Check Database Status
      async function checkDatabaseStatus() {
        try {
          const response = await fetch("/api/csv-import/database-status");
          const result = await response.json();

          if (result.success) {
            const data = result.data;
            let statusHtml = `
               <h4>üìä Database Status</h4>
               <div class="stats-grid">
                 <div class="stat-card">
                   <div class="stat-number">${data.totalAssets}</div>
                   <div class="stat-label">Total Assets</div>
                 </div>
               </div>
             `;

            if (data.assetsByBranch.length > 0) {
              statusHtml += `
                 <h4>üè¢ Assets by Branch</h4>
                 <div class="sample-data">
                   <table class="sample-table">
                     <thead><tr><th>Branch</th><th>Count</th></tr></thead>
                     <tbody>
                       ${data.assetsByBranch
                         .map(
                           (item) => `
                         <tr><td>${item._id || "Unknown"}</td><td>${
                             item.count
                           }</td></tr>
                       `
                         )
                         .join("")}
                     </tbody>
                   </table>
                 </div>
               `;
            }

            if (data.sampleAssets.length > 0) {
              statusHtml += `
                 <h4>üìã Sample Assets</h4>
                 <div class="sample-data">
                   <table class="sample-table">
                     <thead><tr><th>Asset ID</th><th>Name</th><th>Branch</th><th>Status</th></tr></thead>
                     <tbody>
                       ${data.sampleAssets
                         .map(
                           (asset) => `
                         <tr><td>${asset.asset_id}</td><td>${asset.asset_name}</td><td>${asset.branch}</td><td>${asset.status}</td></tr>
                       `
                         )
                         .join("")}
                     </tbody>
                   </table>
                 </div>
               `;
            }

            // Show results in validation section
            const section = document.getElementById("validationSection");
            const content = document.getElementById("validationContent");
            content.innerHTML = statusHtml;
            section.style.display = "block";
          } else {
            alert("Error checking database status: " + result.message);
          }
        } catch (error) {
          console.error("Database status error:", error);
          alert("Error checking database status");
        }
      }

      // Export CSV
      async function exportCSV() {
        try {
          const response = await fetch("/api/csv-import/export");

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `assets-export-${
              new Date().toISOString().split("T")[0]
            }.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            alert("Error exporting CSV file");
          }
        } catch (error) {
          console.error("Export error:", error);
          alert("Error exporting CSV file");
        }
      }
    </script>
  </body>
</html>
